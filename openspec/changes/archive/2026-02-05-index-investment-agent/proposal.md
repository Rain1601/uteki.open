## Why

当前 uteki 平台有 Agent 对话和 SNB 交易能力，但缺少一个专注于指数投资的智能体。指数投资是被动投资的核心策略，需要系统化的数据分析、回测评估和自动化决策支持。用户希望在有限的指数池（<=3 只持仓）中，通过 Agent 的分析与反思做出定投分配、仓位调整、减持等决策，并确保决策过程可观察、可回测、可复现。

借鉴 [nof1.ai Alpha Arena](https://nof1.ai/) 的设计理念——多模型在相同条件下竞争，所有输入输出完全透明——构建一个面向指数投资的 Model Arena，让用户在真实交易决策中评估和选择最优模型。

## What Changes

### 1. 指数数据服务

- 接入 FMP/Alpha Vantage 获取指数 ETF 的实时报价、历史 K 线数据
- 支持每日自动更新和数据准确性验证
- 预设指数：VOO/IVV (S&P500)、QQQ (Nasdaq100)、ACWI (MSCI 全球)、VGT/VITAX (科技)等
- 观察池由用户手动添加 symbol 管理，Agent 可提议新增（需用户确认）

### 2. 回测引擎

- 给定初始资金和月度定投金额，评估指定时间段内指数的收益表现
- Agent 决策的历史回测：用同样的决策逻辑在历史数据上重跑，验证一致性

### 3. IndexAgent 智能体与用户交互

Agent 不是简单的问答机器人，而是一个**主动式投资顾问**，通过结构化的交互卡片与用户协作决策。核心设计原则：**所有模型的输入和输出完全可见**。直接操作实盘，不提供模拟模式。

#### 3.1 交互模式

| 模式 | 触发方 | 场景 |
|------|--------|------|
| **对话模式** | 用户 | 用户主动提问，Agent 回答并提供分析 |
| **决策模式** | 调度器/用户 | 定时或手动触发 Arena 分析，生成决策卡片请求用户批准 |
| **Arena 模式** | 每次决策 | 所有已配置模型并行分析（交易频率低，周/月级别，默认全模型参与） |
| **报告模式** | 调度器/用户 | 定期反思、持仓回顾、模型表现统计 |

#### 3.2 决策调度器

决策以**周/月为频率**，由调度器自动触发，用户可查看、手动触发或编辑调度：

```
┌─────────────────────────────────────────────────────┐
│  ⏰ 决策调度                                         │
│                                                     │
│  ┌─ 定投分析 ─────────────────────────────────────┐ │
│  │ 频率: 每月1日 09:00 UTC                        │ │
│  │ 下次触发: 2026-03-01 09:00 (25天后)            │ │
│  │ 上次执行: 2026-02-01 09:00 ✅                  │ │
│  │ [▶ 立即触发]  [✏️ 编辑调度]                     │ │
│  └────────────────────────────────────────────────┘ │
│                                                     │
│  ┌─ 仓位检查 ─────────────────────────────────────┐ │
│  │ 频率: 每周一 09:00 UTC                         │ │
│  │ 下次触发: 2026-02-10 09:00 (6天后)             │ │
│  │ 上次执行: 2026-02-03 09:00 ✅ (无需调整)       │ │
│  │ [▶ 立即触发]  [✏️ 编辑调度]                     │ │
│  └────────────────────────────────────────────────┘ │
│                                                     │
│  ┌─ 月度反思 ─────────────────────────────────────┐ │
│  │ 频率: 每月最后一个工作日 18:00 UTC              │ │
│  │ 下次触发: 2026-02-27 18:00 (23天后)            │ │
│  │ [▶ 立即触发]  [✏️ 编辑调度]                     │ │
│  └────────────────────────────────────────────────┘ │
│                                                     │
│  [+ 添加调度任务]                                    │
└─────────────────────────────────────────────────────┘
```

调度触发时：自动构建 Harness → 全模型 Arena 分析 → 生成决策卡片推送给用户。

#### 3.3 Decision Harness — 标准化决策上下文（借鉴 nof1.ai）

每次决策前，系统构建一个**不可变的 Decision Harness**（决策输入快照），确保所有模型在完全相同的条件下分析。

**Harness 结构**:
```
Decision Harness #2026-02-01-monthly
├── 📅 时间戳: 2026-02-01T09:00:00Z
├── 🏷️ System Prompt 版本: v1.3 (2026-01-15)
├── 📊 市场数据快照 (截至决策时刻)
│   ├── VOO: $521.30 | PE 21.3 | 52w: $478-$545 | MA50: $515
│   ├── QQQ: $498.20 | PE 28.7 | 52w: $430-$520 | MA50: $490
│   ├── VGT: $432.10 | PE 32.1 | 52w: $380-$450 | MA50: $420
│   └── ACWI: $108.50 | PE 18.9 | 52w: $95-$112 | MA50: $105
├── 💰 账户状态 (自动从 SNB 获取)
│   ├── 现金余额: $3,200
│   ├── 持仓: VOO 10股($5,213) / QQQ 5股($2,491)
│   ├── 持仓比例: VOO 60% / QQQ 29% / 现金 11%
│   └── 总资产: $10,904
├── 📜 历史记忆摘要
│   ├── 上月决策: VOO +2股, QQQ +1股
│   ├── 上月反思: "应在回调时更积极"
│   └── 长期经验: ["Nasdaq回调>5%考虑加仓", ...]
├── 🎯 决策任务
│   ├── 类型: 月度定投分配
│   ├── 预算: $1,000
│   └── 约束: 持仓<=3只, 仅限观察池内标的
└── 🔧 可用工具列表
    └── [get_index_quote, get_index_history, run_backtest, ...]
```

关键设计：
- **Harness 写入后不可变**，与决策结果一起归档
- **System Prompt 版本号记录在 Harness 中**，prompt 变更时自动递增版本，历史对比中标注 prompt 版本分界线，确保在同一 prompt 版本下的模型对比才有意义
- **账户状态自动从 SNB 获取**（余额、持仓），无需手动输入

#### 3.4 模型输入/输出完全可见

**输入可见**：用户可以查看发送给每个模型的完整 prompt，包括 system prompt（含版本号）、Harness 数据、工具定义。

**输出可见**：每个模型的完整响应原文保留，包括：

```
┌─────────────────────────────────────────────────────┐
│  🔍 模型 I/O 详情 — Claude Sonnet                    │
│                                                     │
│  ┌─ INPUT ────────────────────────────────────────┐ │
│  │ [System Prompt v1.3]  展开/收起                 │ │
│  │ 你是一个专业的指数投资顾问。你的目标是...        │ │
│  │                                                │ │
│  │ [Decision Harness]  展开/收起                   │ │
│  │ 当前日期: 2026-02-01                           │ │
│  │ 市场数据: VOO $521.30 PE=21.3 ...              │ │
│  │ 持仓: VOO 10股, QQQ 5股                        │ │
│  │ 任务: 分配本月 $1,000 定投                      │ │
│  │                                                │ │
│  │ [Tools]  展开/收起                              │ │
│  │ 12 个可用工具定义...                            │ │
│  │                                                │ │
│  │ Token 数: 3,847                                │ │
│  └────────────────────────────────────────────────┘ │
│                                                     │
│  ┌─ OUTPUT ───────────────────────────────────────┐ │
│  │ [思考过程]                                      │ │
│  │ 当前市场环境分析:                               │ │
│  │ 1. S&P500 估值 PE=21.3 低于5年均值22.5，        │ │
│  │    处于相对合理区间...                           │ │
│  │ 2. Nasdaq 近期从高点回调 -5%，RSI=38            │ │
│  │    进入超卖区域...                              │ │
│  │ 3. 回顾上月反思"应在回调时更积极"...             │ │
│  │                                                │ │
│  │ [工具调用]                                      │ │
│  │ → get_index_history("QQQ", "30d") → [数据...]   │ │
│  │ → run_backtest("QQQ", ...) → 年化 12.3%        │ │
│  │                                                │ │
│  │ [结构化决策]                                     │ │
│  │ action: ALLOCATE                                │ │
│  │ allocations:                                    │ │
│  │   - { etf: VOO, amount: 600, pct: 60% }        │ │
│  │   - { etf: QQQ, amount: 400, pct: 40% }        │ │
│  │ confidence: 0.85                                │ │
│  │ reasoning: "估值合理+技术面超卖=加仓时机"         │ │
│  │                                                │ │
│  │ Token 数: 1,523 | 延迟: 4.2s | 成本: $0.038    │ │
│  └────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────┘
```

#### 3.5 Model Arena — 多模型对比（借鉴 nof1.ai Alpha Arena）

每次决策默认**全模型参与**（交易频率为周/月级别，成本可接受）。同一 Decision Harness 并行发送给所有已配置模型，在完全相同的输入下独立分析。

**Arena 对比视图**:
```
┌──────────────────────────────────────────────────────────────────┐
│  🏟️ Index Arena — 2026年2月定投分配                    [查看输入] │
│                                                                  │
│  Harness: #2026-02-01 | Prompt v1.3 | 预算 $1,000 | 持仓 VOO+QQQ│
│                                                                  │
│  ┌─ Claude ─────────────┐  ┌─ GPT-4o ─────────────┐             │
│  │ VOO 60% / QQQ 40%   │  │ VOO 50% / QQQ 30%   │             │
│  │                     │  │ VGT 20%             │             │
│  │ 信心度: 85%          │  │ 信心度: 72%          │             │
│  │                     │  │                     │             │
│  │ 核心逻辑:            │  │ 核心逻辑:            │             │
│  │ 估值合理，技术超卖    │  │ 科技超卖，增配VGT    │             │
│  │                     │  │                     │             │
│  │ 4.2s | $0.038       │  │ 3.8s | $0.042       │             │
│  │ [📄 完整 I/O]        │  │ [📄 完整 I/O]        │             │
│  └─────────────────────┘  └─────────────────────┘             │
│                                                                  │
│  ┌─ DeepSeek ───────────┐  ┌─ Gemini ─────────────┐             │
│  │ VOO 70% / QQQ 30%   │  │ 本月不入场            │             │
│  │                     │  │                     │             │
│  │ 信心度: 78%          │  │ 信心度: 65%          │             │
│  │                     │  │                     │             │
│  │ 核心逻辑:            │  │ 核心逻辑:            │             │
│  │ 大盘优先，保守配置    │  │ 不确定性高，等信号    │             │
│  │                     │  │                     │             │
│  │ 2.1s | $0.008       │  │ 3.5s | $0.025       │             │
│  │ [📄 完整 I/O]        │  │ [📄 完整 I/O]        │             │
│  └─────────────────────┘  └─────────────────────┘             │
│                                                                  │
│  [👑 采纳 Claude]  [👑 采纳 GPT-4o]  [👑 其他]  [✏️ 自定义]       │
└──────────────────────────────────────────────────────────────────┘
```

**Arena 流程**:
1. 调度器触发（或用户手动触发）
2. 系统构建 Decision Harness（自动从 SNB 获取账户状态，从数据服务获取市场数据）
3. 同一 Harness 并行发送给所有已配置模型（相同 system prompt v版本 + 数据 + 工具）
4. 每个模型独立分析，返回结构化决策
5. 所有输入、输出、工具调用过程完整记录到 DB
6. Arena 视图并排展示，用户可展开查看任意模型的完整 I/O
7. 用户选择采纳 → 生成决策卡片 → 确认执行（TOTP）

**模型结构化输出规范**（所有模型统一格式）:
```json
{
  "action": "ALLOCATE | REBALANCE | HOLD | SKIP",
  "allocations": [
    { "etf": "VOO", "amount": 600, "percentage": 60 }
  ],
  "confidence": 0.85,
  "reasoning": "简要决策理由",
  "chain_of_thought": "完整思考过程...",
  "tool_calls": [ ... ],
  "risk_assessment": "风险评估",
  "invalidation": "什么情况下此建议无效"
}
```

#### 3.6 决策卡片交互

Arena 生成建议后，通过**决策卡片（Decision Card）**请求用户批准：

**月度定投分配卡片**
```
┌─────────────────────────────────────────┐
│  📊 月度定投建议 — 2026年2月              │
│  来源: Claude (Arena 采纳) | 信心度 85%   │
│                                         │
│  本月预算: $1,000                        │
│                                         │
│  ┌───────┬────────┬────────┬──────────┐ │
│  │ ETF   │ 金额   │ 占比   │ 理由      │ │
│  ├───────┼────────┼────────┼──────────┤ │
│  │ VOO   │ $600  │ 60%   │ 估值合理   │ │
│  │ QQQ   │ $400  │ 40%   │ 技术回调   │ │
│  └───────┴────────┴────────┴──────────┘ │
│                                         │
│  [📄 查看完整分析]  [🏟️ 查看Arena对比]    │
│                                         │
│  [✅ 批准执行]  [✏️ 修改]  [⏸️ 跳过]      │
│  ⚠️ 执行需要 TOTP 验证码                 │
└─────────────────────────────────────────┘
```

**仓位调整卡片** / **新增观察标的卡片** / **反思卡片**：结构类似，均标注来源模型和信心度，均可追溯到完整 I/O。

#### 3.7 对话交互场景

| 用户问题 | Agent 行为 |
|----------|-----------|
| "现在适合买 QQQ 吗？" | 调用数据工具获取估值/技术指标，结合记忆，给出建议 |
| "为什么上个月没有买 VGT？" | 从决策日志检索，展示当时的 Harness 和模型输出 |
| "帮我调研一下 KWEB" | 调用搜索工具调研，生成新增标的卡片 |
| "回测过去5年定投VOO" | 调用回测引擎，生成收益曲线 |
| "上次各模型分析了什么？" | 展示上次 Arena 的完整 I/O 对比 |
| "Claude 和 DeepSeek 谁更准？" | 展示模型排行榜和历史胜率 |
| "下次分析什么时候？" | 展示调度器下次触发时间 |

#### 3.8 反思与记忆

Agent 定期生成反思（由调度器触发），用户可查看和讨论：

```
┌─────────────────────────────────────────┐
│  🔄 月度反思 — 2026年1月                  │
│                                         │
│  ✅ 正确决策:                             │
│  • 1月初增持 VOO，当月涨 +3.2%            │
│  • 采纳 Claude 建议 (当时信心度 82%)       │
│                                         │
│  ❌ 可改进:                               │
│  • QQQ 回调时未加仓，错失低点             │
│  • DeepSeek 当时建议加仓 QQQ 但未采纳     │
│                                         │
│  📌 经验写入长期记忆:                     │
│  • "Nasdaq 回调>5%时考虑加仓"             │
│  • "DeepSeek 在技术面判断上偏激进但有效"   │
│                                         │
│  [💬 讨论]  [📄 查看当月完整 I/O]          │
└─────────────────────────────────────────┘
```

#### 3.9 历史决策时间线 + 反事实追踪

所有决策完整持久化，形成可浏览的时间线。每条记录包含：

- **Harness 快照**：完整市场数据 + 账户状态 + 记忆 + system prompt 版本
- **所有模型的完整 I/O**：input prompt 全文 + output 全文 + 工具调用链
- **用户行为**：采纳了哪个模型 / 修改了什么 / 拒绝原因
- **执行结果**：实际成交价格和数量
- **后续表现**：7d/30d/90d 收益追踪
- **反事实追踪**：未被采纳的建议如果执行了会怎样

```
┌──────────────────────────────────────────────────────────────┐
│  📜 决策历史                                   [筛选] [搜索]  │
│                                                              │
│  2026-02                                                     │
│  ├─ 02-01 月度定投  [Prompt v1.3]                            │
│  │  ├─ 🏟️ Arena: 4模型 [📄 Harness] [📄 全部I/O]            │
│  │  ├─ 👑 采纳: Claude | 信心度 85%                          │
│  │  ├─ ✅ 批准执行                                           │
│  │  ├─ 📊 成交: VOO +2 @ $521, QQQ +1 @ $498                │
│  │  ├─ 📈 30d收益: +2.8%                                    │
│  │  └─ 🔮 反事实:                                           │
│  │     ├─ GPT-4o 方案: 如果执行 → +3.5% (VGT 涨了)          │
│  │     ├─ DeepSeek 方案: 如果执行 → +2.1%                   │
│  │     └─ Gemini 方案(跳过): 如果执行 → 0%                  │
│  │                                                           │
│  2026-01                                                     │
│  ├─ 01-15 仓位调整  [Prompt v1.3]                            │
│  │  ├─ 🏟️ Arena: 4模型 [📄 Harness] [📄 全部I/O]            │
│  │  ├─ 👑 采纳: GPT-4o | 信心度 72%                         │
│  │  ├─ ❌ 用户拒绝 | 备注: "再观察"                          │
│  │  └─ 🔮 反事实:                                           │
│  │     ├─ GPT-4o 方案: 如果执行 → 本可避免 -1.5%            │
│  │     └─ Claude 方案: 如果执行 → -0.3%                     │
│  ...                                                         │
└──────────────────────────────────────────────────────────────┘
```

**反事实追踪**：所有模型的建议（无论是否被采纳）都追踪其假设收益，形成：
- "错过的机会"统计：被拒绝但实际表现好的建议
- "躲过的坑"统计：被拒绝且实际表现差的建议
- 反事实收益也纳入模型排行榜评分（不仅看被采纳的表现）

**不可变原则**: 决策记录写入后不可修改删除。

#### 3.10 模型排行榜（Leaderboard）

长期追踪各模型在指数投资场景的表现，评分同时考虑被采纳和未被采纳的建议：

```
┌──────────────────────────────────────────────────────────────────┐
│  🏆 Model Leaderboard                          [全部] [近3月]    │
│                                                                  │
│  Prompt v1.3 (2026-01-15 ~)                [历史版本▾]           │
│                                                                  │
│  #  模型        采纳率  胜率   平均收益  反事实胜率  总评分  趋势  │
│  1  Claude      45%   68%   +2.8%   72%        92     ↑        │
│  2  DeepSeek    25%   72%   +3.1%   65%        85     ↑        │
│  3  GPT-4o      20%   55%   +1.2%   58%        68     ↓        │
│  4  Gemini      10%   50%   +0.5%   45%        52     →        │
│                                                                  │
│  胜率 = 被采纳建议中正收益比例                                     │
│  反事实胜率 = 所有建议(含未采纳)中正收益比例                        │
│                                                                  │
│  [📊 详细对比]  [📄 各模型历史输出]                                │
└──────────────────────────────────────────────────────────────────┘
```

- **采纳率**: 用户选择该模型建议的比例
- **胜率**: 被采纳建议的后续正收益比例
- **反事实胜率**: 所有建议（含未采纳）的假设正收益比例——反映模型真实判断力
- **按 Prompt 版本分组**: prompt 变更后自动分界，仅同版本内对比才有意义
- **趋势**: 近期评分变化方向

#### 3.11 Agent 工具集

| 工具 | 来源 | 用途 |
|------|------|------|
| `get_index_quote` | 数据服务 | 获取指数 ETF 实时/延迟报价 |
| `get_index_history` | 数据服务 | 获取历史 K 线数据 |
| `run_backtest` | 回测引擎 | 执行回测计算 |
| `get_portfolio` | SNB 客户端 | 获取当前持仓（自动） |
| `get_balance` | SNB 客户端 | 获取账户余额（自动） |
| `get_transactions` | SNB 服务 | 获取交易历史 |
| `place_order` | SNB 客户端 | 执行买入/卖出（需用户确认 + TOTP） |
| `search_web` | 搜索引擎 | 调研新标的/宏观信息 |
| `read_memory` | 记忆模块 | 读取历史决策和经验 |
| `write_memory` | 记忆模块 | 保存新的观察和经验 |
| `get_decision_log` | 决策日志 | 检索历史决策记录和 I/O |

#### 3.12 决策约束

- 持仓指数 ETF 不超过 3 只
- 所有交易操作必须用户确认（决策卡片 + TOTP）
- 严格使用截至决策时刻的历史数据，禁止未来数据泄漏
- 所有模型的完整输入和输出持久化保存，不可删除/修改
- Agent 不会自动执行交易，只生成建议
- Decision Harness 不可变，确保历史复现
- System Prompt 变更时版本号递增，Harness 中记录版本

### 4. 前端页面

- **主视图**: 左侧 Agent 对话流（含决策卡片） + 右侧数据面板（观察池、持仓、K线）
- **Arena 视图**: 多模型并排对比，可展开完整 I/O
- **History 视图**: 决策时间线 + 反事实追踪，每条可展开 Harness + 所有模型 I/O
- **Leaderboard 视图**: 模型排行榜（含反事实胜率）+ 按 Prompt 版本分组
- **Scheduler 视图**: 调度任务管理，展示下次触发时间，可手动触发/编辑
- 所有视图中均可点击 `[📄 完整 I/O]` 查看模型的原始输入和输出

## Capabilities

### New Capabilities

- `index-data`: 指数 ETF 数据服务 — 实时报价、历史 K 线获取与存储、每日更新调度、数据校验
- `index-backtest`: 回测引擎 — 给定初始资金/定投金额/时间范围评估指数收益，以及 Agent 决策的历史回测
- `index-agent`: 指数投资智能体 — 观察池管理、投资决策、反思与记忆模块、决策因素分析、结构化决策卡片交互、SNB 交易工具集成、对话式问答
- `model-arena`: 多模型对比与评估 — Decision Harness 标准化输入（含 system prompt 版本）、全模型并行调用、结构化输出规范、完整 I/O 持久化、用户采纳选择、模型评分与排行榜
- `decision-history`: 决策历史管理 — Harness 快照归档、所有模型完整 I/O 保留、用户行为记录、执行结果追踪、反事实收益追踪、后续收益关联、不可变记录、时间线浏览
- `decision-scheduler`: 决策调度器 — 定时触发决策分析（周/月）、展示下次触发时间、用户手动触发、编辑调度规则
- `index-ui`: 指数投资前端交互 — 对话流、决策卡片、Arena 对比视图（含 I/O 展开）、决策时间线（含反事实）、模型排行榜（含 prompt 版本分组）、调度器面板、观察池卡片、持仓展示、K 线图、回测可视化

### Modified Capabilities

_(无已有 spec 需要修改)_

## Impact

- **新增后端模块**: `backend/uteki/domains/index/` — 数据服务、回测引擎、Agent 逻辑、Decision Harness 构建、多模型调度、记忆/决策持久化、调度器、反事实追踪
- **新增前端页面**: `frontend/src/pages/IndexAgentPage.tsx` 及相关组件（ArenaView、DecisionCard、HarnessViewer、ModelIOPanel、LeaderboardTable、BacktestChart、WatchlistPanel、DecisionTimeline、SchedulerPanel、CounterfactualBadge 等）
- **依赖现有模块**:
  - `domains/agent/llm_adapter.py` — LLM 多模型调用与 function calling 基础设施
  - `domains/snb/services/snb_client.py` — 交易执行 + 账户数据自动获取
  - `domains/agent/research/` — 网络搜索用于 Agent 调研新指数
- **新增外部依赖**: FMP API / Alpha Vantage API（已有 API Key 配置）
- **数据库**: 新增 `index` schema — 指数历史数据表、Decision Harness 表、模型 I/O 记录表、决策日志表、Agent 记忆表、回测结果表、观察池表、模型评分表、调度任务表、反事实追踪表、system prompt 版本表
- **API**: 新增 `/api/index/` 路由组（数据、Agent 对话、Arena 多模型调用、决策历史、模型排行、回测、调度管理）
